<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Disable zoom on double-tap and pinch -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ChemDrop: Acid-Base Lab</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --acid-color: #ff4757;
      --acid-glow:  #ff6b81;
      --base-color: #1e90ff;
      --base-glow:  #70b8ff;
      --neutral-color: #2ed573;
      --neutral-glow:  #7bed9f;
      --bg-dark:  #0a0e1a;
      --bg-panel: #111827;
      --text-primary: #e2e8f0;
      --text-dim:     #94a3b8;
    }

    /* ── Reset touch behaviours everywhere ── */
    html, body {
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100vh;
      min-height: 100dvh;
      overflow: hidden;
      user-select: none;
    }

    /* ── Starfield ── */
    #stars {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    /* ── Wrapper — fluid, max 480px ── */
    #wrapper {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    /* ── HUD ── */
    #hud {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      background: var(--bg-panel);
      border-radius: 14px 14px 0 0;
      border: 1px solid #1e2d45;
      border-bottom: none;
    }

    .hud-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .hud-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
    }
    .hud-value {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(16px, 5vw, 22px);
      color: var(--text-primary);
    }

    .hearts { display: flex; gap: 4px; font-size: clamp(14px, 4vw, 18px); }

    #level-display {
      background: linear-gradient(135deg,#6c63ff,#a855f7);
      padding: 3px 12px;
      border-radius: 999px;
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(12px, 4vw, 15px);
    }

    /* ── Canvas container — keeps aspect ratio ── */
    #canvas-container {
      position: relative;
      width: 100%;
      /* 480 × 520 native → ratio ≈ 0.923 */
      padding-bottom: 108.33%; /* (520/480)*100 */
      background: linear-gradient(180deg,#060c1a 0%,#0d1b33 60%,#0a1226 100%);
      border-left:  1px solid #1e2d45;
      border-right: 1px solid #1e2d45;
      overflow: hidden;
    }

    #gameCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
      cursor: none;
    }

    /* Feedback overlay text */
    #feedback {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(16px, 5vw, 22px);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
      text-shadow: 0 0 12px currentColor;
      white-space: nowrap;
    }

    /* ── Overlay screens ── */
    .overlay {
      position: absolute;
      inset: 0;
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 14px;
      background: rgba(6,12,26,0.92);
      backdrop-filter: blur(6px);
    }
    .overlay h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(20px, 6vw, 28px);
      text-align: center;
      background: linear-gradient(90deg,#6c63ff,#a855f7,#ff4757);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .overlay p {
      color: var(--text-dim);
      font-size: clamp(11px, 3.2vw, 13px);
      text-align: center;
      max-width: min(320px, 80%);
      line-height: 1.6;
      padding: 0 12px;
    }
    .btn-primary {
      padding: 12px 36px;
      background: linear-gradient(135deg,#6c63ff,#a855f7);
      border: none;
      border-radius: 999px;
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(12px, 3.5vw, 14px);
      color: #fff;
      cursor: pointer;
      transition: transform 0.12s, box-shadow 0.12s;
      box-shadow: 0 4px 20px rgba(108,99,255,0.4);
      touch-action: manipulation;
    }
    .btn-primary:hover, .btn-primary:active {
      transform: translateY(-2px);
      box-shadow: 0 8px 28px rgba(108,99,255,0.6);
    }

    .legend {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-dim);
    }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    .big-score {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(36px, 10vw, 48px);
      background: linear-gradient(90deg,#ffd700,#ffa502);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* ── Controls bar ── */
    #controls-bar {
      width: 100%;
      background: var(--bg-panel);
      border: 1px solid #1e2d45;
      border-top: none;
      border-radius: 0 0 14px 14px;
      padding: 10px 12px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    /* Row: ← | A S D | → */
    .controls-main-row {
      display: flex;
      align-items: stretch;
      gap: 8px;
      width: 100%;
      justify-content: center;
    }

    /* Arrow buttons */
    .arrow-btn {
      flex: 0 0 52px;
      min-height: 60px;
      background: #1a2540;
      border: 2px solid #2a3f6a;
      border-radius: 10px;
      color: var(--text-primary);
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      touch-action: none;   /* handle our own touch */
      user-select: none;
      transition: background 0.1s, transform 0.08s;
      -webkit-tap-highlight-color: transparent;
    }
    .arrow-btn:active { background: #253560; transform: scale(0.94); }

    /* Type buttons */
    .type-btns {
      display: flex;
      gap: 8px;
      flex: 1;
      justify-content: center;
    }

    .key-btn {
      flex: 1;
      min-width: 0;
      padding: 8px 4px 6px;
      border-radius: 10px;
      border: 2px solid transparent;
      background: #1a2540;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.15s;
      font-family: 'Inter', sans-serif;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .key-btn .kbd {
      font-family: 'Orbitron', sans-serif;
      font-size: clamp(11px, 3.5vw, 14px);
      font-weight: 700;
      color: #fff;
    }
    .key-btn .label {
      font-size: clamp(8px, 2.5vw, 10px);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .key-btn[data-type="acid"]    { border-color: var(--acid-color); }
    .key-btn[data-type="base"]    { border-color: var(--base-color); }
    .key-btn[data-type="neutral"] { border-color: var(--neutral-color); }
    .key-btn.active[data-type="acid"]    { background: #3d0f16; box-shadow: 0 0 14px var(--acid-color);    transform: scale(1.07); }
    .key-btn.active[data-type="base"]    { background: #0d1f3e; box-shadow: 0 0 14px var(--base-color);    transform: scale(1.07); }
    .key-btn.active[data-type="neutral"] { background: #0d2a1a; box-shadow: 0 0 14px var(--neutral-color); transform: scale(1.07); }

    .move-hint {
      font-size: 10px;
      color: var(--text-dim);
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>

<canvas id="stars"></canvas>

<div id="wrapper">
  <!-- HUD -->
  <div id="hud">
    <div class="hud-item">
      <span class="hud-label">Score</span>
      <span class="hud-value" id="score-display">0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Level</span>
      <span id="level-display">1</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">Lives</span>
      <div class="hearts" id="hearts-display">❤️❤️❤️</div>
    </div>
  </div>

  <!-- Canvas -->
  <div id="canvas-container">
    <canvas id="gameCanvas" width="480" height="520"></canvas>
    <div id="feedback"></div>

    <!-- Start Screen -->
    <div class="overlay" id="startScreen">
      <h1>⚗️ ChemDrop<br/>Acid-Base Lab</h1>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--acid-color)"></div> Acid → A</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--base-color)"></div> Base → S</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--neutral-color)"></div> Neutral → D</div>
      </div>
      <p>Formulas fall from the sky. Pick the right basket type with tap the buttons below then move with <b>← →</b> or the arrows. Good luck, chemist!</p>
      <button class="btn-primary" id="startBtn">Start Game</button>
    </div>

    <!-- Game Over Screen -->
    <div class="overlay" id="gameOverScreen" style="display:none">
      <h1>Game Over</h1>
      <p>Nice effort, chemist!</p>
      <div class="big-score" id="finalScore">0</div>
      <p style="margin-top:-8px;font-size:12px;">Final Score</p>
      <button class="btn-primary" id="restartBtn">Play Again</button>
    </div>
  </div>

  <!-- Controls bar -->
  <div id="controls-bar">
    <div class="controls-main-row">
      <!-- Left arrow -->
      <button class="arrow-btn" id="arrowLeft" aria-label="Move Left">&#8592;</button>

      <!-- Type buttons -->
      <div class="type-btns">
        <button class="key-btn active" data-type="acid" id="btnA">
          <span class="kbd">A</span>
          <span class="label" style="color:var(--acid-color)">Acid</span>
        </button>
        <button class="key-btn" data-type="base" id="btnS">
          <span class="kbd">S</span>
          <span class="label" style="color:var(--base-color)">Base</span>
        </button>
        <button class="key-btn" data-type="neutral" id="btnD">
          <span class="kbd">D</span>
          <span class="label" style="color:var(--neutral-color)">Neutral</span>
        </button>
      </div>

      <!-- Right arrow -->
      <button class="arrow-btn" id="arrowRight" aria-label="Move Right">&#8594;</button>
    </div>
    <div class="move-hint">Tap &amp; hold ← → to move &nbsp;|&nbsp; Drag canvas to slide</div>
  </div>
</div>

<script>
// ─────────────────────────────────────────────
// Starfield (background animation)
// ─────────────────────────────────────────────
(function(){
  const c  = document.getElementById('stars');
  const cx = c.getContext('2d');
  function resize(){ c.width = window.innerWidth; c.height = window.innerHeight; }
  resize();
  window.addEventListener('resize', resize);
  const stars = Array.from({length:160},()=>({
    x: Math.random()*window.innerWidth,
    y: Math.random()*window.innerHeight,
    r: Math.random()*1.4+0.3,
    a: Math.random(),
    da: (Math.random()-0.5)*0.006
  }));
  (function draw(){
    cx.clearRect(0,0,c.width,c.height);
    stars.forEach(s=>{
      s.a = Math.max(0.1,Math.min(1,s.a+s.da));
      if(s.a<=0.1||s.a>=1) s.da*=-1;
      cx.beginPath();
      cx.arc(s.x,s.y,s.r,0,Math.PI*2);
      cx.fillStyle=`rgba(255,255,255,${s.a})`;
      cx.fill();
    });
    requestAnimationFrame(draw);
  })();
})();

// ─────────────────────────────────────────────
// Chemistry Data
// ─────────────────────────────────────────────
const CHEMICALS = {
  acid:    ['HCl','H₂SO₄','HNO₃','CH₃COOH','HF','H₂CO₃'],
  base:    ['NaOH','KOH','NH₃','Ba(OH)₂','Ca(OH)₂'],
  neutral: ['NaCl','H₂O','KNO₃','Na₂SO₄']
};
const TYPE_COLOR = { acid:'#ff4757', base:'#1e90ff', neutral:'#2ed573' };
const TYPE_GLOW  = { acid:'#ff6b81', base:'#70b8ff', neutral:'#7bed9f' };

// ─────────────────────────────────────────────
// Canvas & logical dimensions (kept fixed for easy math)
// ─────────────────────────────────────────────
const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');
const W = 480, H = 520;   // logical size — CSS scales the rest

// ─────────────────────────────────────────────
// Game State
// ─────────────────────────────────────────────
let state = 'start';
let score, lives, level, drops, basket, keys,
    lastDrop, baseSpeed, spawnInterval, flashTimer;

const BASKET_W = 110;
const BASKET_H = 44;
const BASKET_Y = H - 62;

function initGame(){
  score = 0; lives = 3; level = 1; drops = []; keys = {};
  lastDrop = 0; flashTimer = 0;
  // ── SLOWER initial speeds ──
  baseSpeed     = 1.1;   // was 1.8
  spawnInterval = 2200;  // was 1800
  basket = { x: W/2 - BASKET_W/2, type:'acid', speed:6, shake:false };
  updateHUD();
}

function updateHUD(){
  document.getElementById('score-display').textContent = score;
  const h = document.getElementById('hearts-display');
  h.textContent = '❤️'.repeat(Math.max(0,lives));
  // recalculate level FIRST, then update speed
  const newLevel = Math.floor(score/50)+1;
  if(newLevel !== level){
    level = newLevel;
    document.getElementById('level-display').textContent = level;
  }
  // ── GENTLER speed ramp: +0.18 per level (was 0.35) ──
  baseSpeed     = 1.1 + (level-1)*0.18;
  // ── Interval floor raised to 1000ms (was 700), step smaller ──
  spawnInterval = Math.max(1000, 2200 - (level-1)*100);
}

// ─────────────────────────────────────────────
// Scale helper — maps a CSS-space touch X to logical canvas X
// ─────────────────────────────────────────────
function toLogicalX(clientX){
  const rect  = canvas.getBoundingClientRect();
  return (clientX - rect.left) * (W / rect.width);
}

// ─────────────────────────────────────────────
// Keyboard Input
// ─────────────────────────────────────────────
document.addEventListener('keydown', e=>{
  keys[e.key] = true;
  if(state !== 'playing') return;
  if(e.key==='a'||e.key==='A') setType('acid');
  if(e.key==='s'||e.key==='S') setType('base');
  if(e.key==='d'||e.key==='D') setType('neutral');
  if(['ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
});
document.addEventListener('keyup', e=>{ keys[e.key]=false; });

// ─────────────────────────────────────────────
// On-screen ← → buttons (hold-to-move via interval)
// ─────────────────────────────────────────────
function holdKey(virtualKey, el){
  let tid = null;
  function start(e){ e.preventDefault(); keys[virtualKey]=true; }
  function stop(e){  e.preventDefault(); keys[virtualKey]=false; }
  el.addEventListener('mousedown', start);
  el.addEventListener('mouseup',   stop);
  el.addEventListener('mouseleave',stop);
  el.addEventListener('touchstart',start,{passive:false});
  el.addEventListener('touchend',  stop, {passive:false});
  el.addEventListener('touchcancel',stop,{passive:false});
}
holdKey('ArrowLeft',  document.getElementById('arrowLeft'));
holdKey('ArrowRight', document.getElementById('arrowRight'));

// ─────────────────────────────────────────────
// Canvas touch — drag basket horizontally
// ─────────────────────────────────────────────
let touchDragX = null;

canvas.addEventListener('touchstart', e=>{
  e.preventDefault();
  if(state !== 'playing') return;
  touchDragX = toLogicalX(e.touches[0].clientX);
}, {passive:false});

canvas.addEventListener('touchmove', e=>{
  e.preventDefault();
  if(state !== 'playing' || touchDragX === null) return;
  const newX = toLogicalX(e.touches[0].clientX);
  const dx   = newX - touchDragX;
  touchDragX = newX;
  basket.x = Math.max(0, Math.min(W - BASKET_W, basket.x + dx));
}, {passive:false});

canvas.addEventListener('touchend',   e=>{ e.preventDefault(); touchDragX = null; },{passive:false});
canvas.addEventListener('touchcancel',e=>{ e.preventDefault(); touchDragX = null; },{passive:false});

// ─────────────────────────────────────────────
// Type-switch buttons (A / S / D)
// ─────────────────────────────────────────────
document.querySelectorAll('.key-btn').forEach(btn=>{
  // Both click (desktop) and touchstart (mobile, no 300ms delay)
  function activate(e){
    e.preventDefault();
    if(state==='playing') setType(btn.dataset.type);
  }
  btn.addEventListener('click',      activate);
  btn.addEventListener('touchstart', activate, {passive:false});
});

function setType(t){
  if(!basket) return;
  basket.type = t;
  document.querySelectorAll('.key-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.type===t);
  });
}

// ─────────────────────────────────────────────
// Screen transitions
// ─────────────────────────────────────────────
document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('restartBtn').addEventListener('click', startGame);

function startGame(){
  document.getElementById('startScreen').style.display  = 'none';
  document.getElementById('gameOverScreen').style.display = 'none';
  initGame();
  state = 'playing';
}

// ─────────────────────────────────────────────
// Drops
// ─────────────────────────────────────────────
function spawnDrop(ts){
  const typePile = ['acid','acid','base','base','neutral'];
  const type     = typePile[Math.floor(Math.random()*typePile.length)];
  const formula  = CHEMICALS[type][Math.floor(Math.random()*CHEMICALS[type].length)];
  drops.push({
    x: 34 + Math.random()*(W-68),
    y: -32,
    formula, type,
    speed: baseSpeed + Math.random()*0.4,  // tighter speed variance (was 0.6)
    angle: (Math.random()-0.5)*0.25,
    wobble: 0,
    bobAmp:  Math.random()*0.9+0.3,        // gentler wobble (was 1.2+0.4)
    bobFreq: Math.random()*1.5+0.8,
    spawnTs: ts
  });
}

function drawDrop(d){
  const col  = TYPE_COLOR[d.type];
  const glow = TYPE_GLOW[d.type];

  ctx.save();
  ctx.translate(d.x, d.y);
  ctx.rotate(d.angle);

  ctx.shadowColor = glow;
  ctx.shadowBlur  = 18;

  ctx.font = 'bold 14px Inter, sans-serif';
  const tw = ctx.measureText(d.formula).width + 28;
  const th = 30;

  roundRect(ctx,-tw/2,-th/2,tw,th,8);
  ctx.fillStyle   = col + '28';
  ctx.fill();
  ctx.strokeStyle = col;
  ctx.lineWidth   = 2;
  ctx.stroke();

  ctx.shadowBlur     = 8;
  ctx.fillStyle      = '#fff';
  ctx.textAlign      = 'center';
  ctx.textBaseline   = 'middle';
  ctx.fillText(d.formula, 0, 0);

  ctx.beginPath();
  ctx.arc(tw/2-10, 0, 4, 0, Math.PI*2);
  ctx.fillStyle  = col;
  ctx.shadowBlur = 10;
  ctx.fill();

  ctx.restore();
}

// ─────────────────────────────────────────────
// Basket
// ─────────────────────────────────────────────
function drawBasket(){
  const bx  = basket.x;
  const shy = basket.shake ? Math.sin(Date.now()*0.05)*3 : 0;
  const by  = BASKET_Y + shy;
  const col  = TYPE_COLOR[basket.type];
  const glow = TYPE_GLOW[basket.type];

  ctx.save();
  ctx.shadowColor = glow;
  ctx.shadowBlur  = 26;

  const grad = ctx.createLinearGradient(bx,by,bx,by+BASKET_H);
  grad.addColorStop(0, col+'88');
  grad.addColorStop(1, col+'22');
  roundRect(ctx,bx,by,BASKET_W,BASKET_H,10);
  ctx.fillStyle = grad;
  ctx.fill();
  ctx.strokeStyle = col;
  ctx.lineWidth   = 2.5;
  ctx.stroke();

  ctx.shadowBlur = 0;
  roundRect(ctx,bx+6,by+5,BASKET_W-12,8,4);
  ctx.fillStyle = 'rgba(255,255,255,0.12)';
  ctx.fill();

  ctx.fillStyle    = '#fff';
  ctx.font         = 'bold 13px Orbitron, sans-serif';
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(basket.type.toUpperCase(), bx+BASKET_W/2, by+BASKET_H/2+2);

  ctx.beginPath();
  ctx.moveTo(bx-4,by);
  ctx.lineTo(bx+BASKET_W+4,by);
  ctx.strokeStyle = col;
  ctx.lineWidth   = 3;
  ctx.shadowColor = glow;
  ctx.shadowBlur  = 10;
  ctx.stroke();

  ctx.restore();
}

// ─────────────────────────────────────────────
// Particles
// ─────────────────────────────────────────────
let particles = [];

function spawnParticles(x,y,col,success){
  for(let i=0;i<18;i++){
    const a = Math.random()*Math.PI*2;
    const s = Math.random()*5+2;
    particles.push({x,y, vx:Math.cos(a)*s, vy:Math.sin(a)*s*(success?-1:1),
                    life:1, col, r:Math.random()*4+2});
  }
}

function updateParticles(){
  particles = particles.filter(p=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.15; p.life-=0.035;
    ctx.save();
    ctx.globalAlpha=p.life;
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle=p.col; ctx.shadowColor=p.col; ctx.shadowBlur=8;
    ctx.fill(); ctx.restore();
    return p.life>0;
  });
}

// ─────────────────────────────────────────────
// Feedback text
// ─────────────────────────────────────────────
function showFeedback(text,col){
  const el=document.getElementById('feedback');
  el.textContent=text; el.style.color=col; el.style.opacity='1';
  clearTimeout(flashTimer);
  flashTimer=setTimeout(()=>{ el.style.opacity='0'; },700);
}

// ─────────────────────────────────────────────
// Grid (lab aesthetic)
// ─────────────────────────────────────────────
function drawGrid(){
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.03)';
  ctx.lineWidth=1;
  for(let x=0;x<W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
  for(let y=0;y<H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  ctx.restore();
}

// ─────────────────────────────────────────────
// Collision
// ─────────────────────────────────────────────
function checkCollisions(){
  const bL=basket.x, bR=basket.x+BASKET_W;
  const bT=BASKET_Y, bB=BASKET_Y+BASKET_H;
  drops=drops.filter(d=>{
    if(d.y>H+20){
      loseLife();
      showFeedback('MISS!','#ff4757');
      spawnParticles(d.x,H-20,'#ff4757',false);
      return false;
    }
    if(d.y+14>=bT && d.y-14<=bB && d.x>=bL && d.x<=bR){
      if(d.type===basket.type){
        score+=10;
        updateHUD();
        spawnParticles(d.x,d.y,TYPE_GLOW[d.type],true);
        showFeedback('+10',TYPE_COLOR[d.type]);
      } else {
        loseLife();
        basket.shake=true;
        setTimeout(()=>basket.shake=false,400);
        spawnParticles(d.x,d.y,'#ff4757',false);
        showFeedback('WRONG!','#ff4757');
      }
      return false;
    }
    return true;
  });
}

function loseLife(){
  lives=Math.max(0,lives-1);
  updateHUD();
  if(lives<=0) endGame();
}

function endGame(){
  state='over';
  document.getElementById('finalScore').textContent=score;
  document.getElementById('gameOverScreen').style.display='flex';
}

// ─────────────────────────────────────────────
// Main Loop
// ─────────────────────────────────────────────
let lastTs=0;

function loop(ts){
  requestAnimationFrame(loop);
  if(state!=='playing') return;

  lastTs=ts;

  ctx.clearRect(0,0,W,H);
  drawGrid();

  // Keyboard movement
  if(keys['ArrowLeft'])  basket.x=Math.max(0,basket.x-basket.speed);
  if(keys['ArrowRight']) basket.x=Math.min(W-BASKET_W,basket.x+basket.speed);

  // Spawn
  if(ts-lastDrop>spawnInterval){ spawnDrop(ts); lastDrop=ts; }

  // Update drops
  drops.forEach(d=>{
    d.y+=d.speed;
    d.wobble+=0.05;
    d.x+=Math.sin(d.wobble*d.bobFreq)*d.bobAmp;
    d.x=Math.max(20,Math.min(W-20,d.x));
    drawDrop(d);
  });

  checkCollisions();
  updateParticles();
  drawBasket();
}

requestAnimationFrame(loop);

// ─────────────────────────────────────────────
// Helpers
// ─────────────────────────────────────────────
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}
</script>
</body>
</html>
